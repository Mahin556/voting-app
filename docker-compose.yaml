version: "3.8"

services:
  mongo-0:
    image: mongo:6
    restart: always
    command:
    - mongod
    - --replSet
    - rs0
    - --auth
    - --keyFile
    - /etc/mongo-keyfile
    - --bind_ip
    - 0.0.0.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    volumes:
      - mongo0-data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks:
      - voting_app
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh mongodb://root:example@localhost:27017/ --quiet
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 20s

  mongo-1:
    image: mongo:6
    restart: always
    command:
    - mongod
    - --replSet
    - rs0
    - --auth
    - --keyFile
    - /etc/mongo-keyfile
    - --bind_ip
    - 0.0.0.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    volumes:
      - mongo1-data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks:
      - voting_app
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh mongodb://root:example@localhost:27017/ --quiet
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 20s
      
  mongo-2:
    image: mongo:6
    restart: always
    command:
    - mongod
    - --replSet
    - rs0
    - --auth
    - --keyFile
    - /etc/mongo-keyfile
    - --bind_ip
    - 0.0.0.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    volumes:
      - mongo2-data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks:
      - voting_app
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh mongodb://root:example@localhost:27017/ --quiet
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 20s

  backend:
    image: mahinraza556/voting-app:backend
    restart: always
    environment:
      MONGO_CONN_STR: mongodb://root:example@mongo-0:27017,mongo-1:27017,mongo-2:27017/langdb?replicaSet=rs0&authSource=admin
      MONGO_USERNAME: root
      MONGO_PASSWORD: example
    depends_on:
      mongo-0:
        condition: service_healthy
      mongo-1:
        condition: service_healthy
      mongo-2:
        condition: service_healthy
    networks:
      - voting_app
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/ok || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 40s
      
  frontend:
    image: mahinraza556/voting-app:frontend
    restart: always
    ports:
      - "80:8080"
    environment:
      - REACT_APP_APIHOSTPORT=192.168.29.173:8080
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - voting_app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ok"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 20s
    
networks:
  voting_app:
    driver: bridge
  
volumes:
  mongo0-data:
  mongo1-data:
  mongo2-data: